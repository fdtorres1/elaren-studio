---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import SeoHero from '../components/seo/SeoHero.astro';
import SeoPricing from '../components/seo/SeoPricing.astro';
import SeoFaq from '../components/seo/SeoFaq.astro';
import SeoCta from '../components/seo/SeoCta.astro';
import CrossLinks from '../components/seo/CrossLinks.astro';
import { getRelatedPages, buildStructuredData, buildFaqSchema } from '../lib/seo-pages';
import { resolveCta } from '../lib/cta-presets';
import { getResourceUrl, TYPE_LABELS } from '../lib/resources';
import type { Resource } from '../lib/resources';

export async function getStaticPaths() {
	const pages = await getCollection('seoPages');
	return pages.map((page) => ({
		params: { slug: page.id },
		props: { page },
	}));
}

const { page } = Astro.props;
const { Content } = await render(page);
const relatedPages = await getRelatedPages(page);
const siteUrl = Astro.site?.origin ?? 'https://elarenstudio.com';
const structuredData = buildStructuredData(page, siteUrl);
const faqSchema = buildFaqSchema(page);
const pageTitle = page.data.title;
const pricingVariant = page.data.pageType === 'practice-type' ? 'stepped' : 'stacked';
const cta = resolveCta(page.data.ctaPreset, page.data.ctaText, page.data.ctaHref);

const breadcrumbs = [
	{ label: "Home", href: "/" },
	{ label: pageTitle },
];

const allResources = await getCollection("resources", ({ data }) => !data.draft);
const relatedResources = allResources
	.filter((r: Resource) => r.data.vertical === page.data.vertical)
	.slice(0, 3);
---

<BaseLayout title={pageTitle} description={page.data.description}>
	<Header />
	<main>
		<div class="container pt-6">
			<Breadcrumbs items={breadcrumbs} />
		</div>

		<SeoHero
			kicker={page.data.heroKicker}
			h1={page.data.h1}
			subtitle={page.data.heroSubtitle}
			trustLine={page.data.trustLine}
			ctaText={cta.text}
			ctaHref={cta.href}
		/>

		<Content />

		<SeoPricing variant={pricingVariant} />

		{page.data.faqs.length > 0 && (
			<SeoFaq
				faqs={page.data.faqs}
				title={page.data.faqSectionTitle}
				subtitle={page.data.faqSectionSubtitle}
			/>
		)}

		<CrossLinks relatedPages={relatedPages} />

		{relatedResources.length > 0 && (
			<section class="relative py-16 md:py-24 overflow-hidden" style="background-color: #eef2f6;">
				<div class="container relative z-10">
					<div class="max-w-3xl mx-auto">
						<p class="text-sm font-medium text-accent uppercase tracking-wider mb-3">From our resources</p>
						<h2 class="text-2xl md:text-3xl font-semibold mb-6 text-ink">Helpful reading</h2>
						<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
							{relatedResources.map((r: Resource) => (
								<a
									href={getResourceUrl(r)}
									class="rounded-xl border-2 border-slate-200 bg-white p-5 hover:border-accent/30 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 no-underline group"
								>
									<span class="text-xs font-medium uppercase tracking-wider text-accent">{TYPE_LABELS[r.data.type]}</span>
									<h3 class="font-semibold text-ink mt-1 mb-1 group-hover:text-accent transition-colors">{r.data.title}</h3>
									{r.data.description && (
										<p class="text-sm text-ink/60 line-clamp-2">{r.data.description}</p>
									)}
								</a>
							))}
						</div>
					</div>
				</div>
			</section>
		)}

		<SeoCta
			headline={page.data.finalCtaHeadline}
			subtext={page.data.finalCtaSubtext}
			ctaText={cta.text}
			ctaHref={cta.href}
		/>
	</main>
	<Footer />

	<script type="application/ld+json" set:html={JSON.stringify(structuredData)} />
	{faqSchema && (
		<script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />
	)}
</BaseLayout>
